/*
 * Copyright (c) 2018. Vojin Petrovic.
 */
(function(b){b.fn.vojjinSelect=function(c){function d(){if(n.wrap('<div class="vojjinsel_wrap"></div>'),t=n.parent(),t.css('flex-direction','column'),n.addClass('vojjinsel_important'),o=b('<input>').appendTo(t).attr('type','hidden').attr('id',y+'_vojjinsel_id').attr('name',y+'_vojjinsel_name'),o.val(''),r=b('<div>').appendTo(t).addClass('vojjinsel_maindiv').css('width',t.width()+'px'),t.append('<span class="vojjinsel_wrap_span"><span class="vojjinsel_wrap_arrow"></span></span>'),b('.vojjinsel_wrap_span').height(n.innerHeight()),(m.preload||1<m.data.length)&&(m.delayOnType=10),b(document).on('click','.vojjinsel_p',function(){let z=parseInt(b(this).data('id').toString()),A=b(this).text().toString();n.data('selId',z),n.data('selText',A),o.val(z+''),n.val(A),l(),n.trigger('myChange')}),b(window).resize(function(){r.css('width',t.width()+'px')}),m.preload&&0===m.data.length){let z={q:'',mx:0,sort:m.sort,preload:1,mr:m.maxToRetrieve};b.ajax({url:m.action,type:'POST',dataType:'json',data:z,success:function(A){0<A.length&&(x=[],A.forEach(function(B){x.push({id:B.id,t:B.t,q:B.q})}))}})}else 0<m.data.length&&(m.preload=!0,x=[],m.data.forEach(function(z){x.push({id:z.id,t:z.t,q:z.q})}))}function f(){o.val(''),h()}function g(){o.val('');try{clearTimeout(u)}catch(z){}try{clearTimeout(v)}catch(z){}try{clearTimeout(w)}catch(z){}u=setTimeout(function(){h()},m.delayOnType)}function h(){if(!m.preload){let z={q:b.trim(n.val().toString()),mx:m.maxShowEmpty,sort:m.sort,mr:m.maxToRetrieve};b.ajax({url:m.action,type:'POST',dataType:'json',data:z,success:function(A){i(A,z.q)}})}else{let z=b.trim(n.val().toString()),A=[];''===z?(x.length<=m.maxShowEmpty||0===m.maxShowEmpty)&&x.forEach(function(B){A.push({id:B.id,t:B.t})}):x.forEach(function(B){let C=B.t.toLowerCase();B.hasOwnProperty('q')&&(C=B.q.toLowerCase()),-1<C.indexOf(z.toLowerCase())&&A.push({id:B.id,t:B.t})}),i(A,z)}}function i(z,A){0===z.length?''===A?l():m.showEmptyResult?k():l():j(z)}function j(z){let A='';z.length===m.maxToRetrieve&&0<m.maxToRetrieve&&m.showTooManyResult&&(A+='<p class="vojjinsel_p_max">'+m.tooManyResults.replace('{1}',m.maxToRetrieve)+'</p>',0<m.hideTooManyResultAfter&&(w=setTimeout(function(){b('.vojjinsel_p_max').hide('slow')},m.hideTooManyResultAfter))),z.forEach(function(B){A+='<p class="vojjinsel_p" data-id="'+B.id+'">'+B.t+'</p>'}),r.html(A).addClass('vojjinsel_active')}function k(){let z='<p class="vojjinsel_p_empty">'+m.emptyResult+'</p>';r.html(z).addClass('vojjinsel_active'),0<m.hideEmptyResultAfter&&(v=setTimeout(function(){l()},m.hideEmptyResultAfter))}function l(){r.html('').removeClass('vojjinsel_active')}let o,r,t,u,v,w,m=b.extend({action:'',func:'',delayOnType:600,preload:!1,data:[],sort:2,maxShowEmpty:0,emptyResult:'No matches',showEmptyResult:!0,hideEmptyResultAfter:1500,maxToRetrieve:0,tooManyResults:'Displaying first {1} items',showTooManyResult:!0,hideTooManyResultAfter:1500},c),n=this,x=[],y=n.attr('id');return'getid'===m.func?n.data('selId'):'gettext'===m.func?n.data('selText'):(this.on('blur',function(){setTimeout(function(){l()},300)}),this.on('focus',function(){f()}),this.on('keyup',function(){g()}),this.each(function(){d()}),this)}})(jQuery);